<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vehicle plate recognition</title>

    <style>
        table#view {
            border-collapse: collapse;
            border-spacing: 0;
            border: 0;
            width: 100%;
        }

        table#view td {
            border: solid 1px black;
        }

        #img-canvas {
            box-sizing: border-box;
            min-height: 30em;
        }

        #indicators {
            display: block;
            position: absolute;
            box-sizing: border-box;
            width: fit-content;
        }

        #indicators>* {
            position: absolute;
            display: block;
            box-sizing: border-box;
            outline: 4px solid #00ff00;
            border-radius: 2px;
        }

        #indicators>*>* {
            position: relative;
            display: block;
            margin: auto;
            box-sizing: border-box;
            background-color: bisque;
            top: -1em;
            padding: 2px 8px;
            font-family: "Roboto", sans-serif;
            font-weight: bolder;
            min-width: 7em;
            text-align: center;
        }
    </style>
</head>

<body style="background-color: #d0d0d0;">

    <div>
        <h1 style="text-align: center;">Ứng dụng python nhận diện biển số xe</h1>
    </div>

    <div>

        <div>
            <table id="view">
                <tr>
                    <td>
                        <div id="img-canvas">
                            <div id="indicators"></div>
                            <div>
                                <img id="img-view" style="display: block;max-width: 100%;max-height: 80vh;">
                            </div>
                        </div>
                    </td>
                    <td style="width: 30em;padding: 2em 1em;vertical-align: top;">
                        <form id="input-form" action="/" method="POST" enctype="multipart/form-data">
                            <label>Nhập hình ảnh: <input type="file" name="file"></label>
                        </form>

                        <br>

                        <div id="result-view"></div>
                    </td>
                </tr>
            </table>
        </div>

        <script>
            {
                const { currentScript } = document

                const inputForm = document.getElementById("input-form")
                const imageView = document.getElementById("img-view")
                const indicatorsElm = document.getElementById("indicators")
                const resultView = document.getElementById("result-view")

                function showIndicators(indicators) {
                    const fragment = document.createDocumentFragment()
                    if (Array.isArray(indicators)) indicators.forEach(ind => {
                        const div = document.createElement('div')

                        const r = imageView.width / imageView.naturalWidth

                        div.style.left = (ind.x * r) + "px"
                        div.style.top = (ind.y * r) + "px"
                        div.style.width = (ind.w * r) + "px"
                        div.style.height = (ind.h * r) + "px"

                        const plate = document.createElement('div')
                        plate.innerText = ind.text

                        div.replaceChildren(plate)

                        fragment.append(div)
                    })

                    indicatorsElm.replaceChildren(fragment)
                }

                inputForm.file.addEventListener('change', function (event) {
                    showIndicators([])
                    resultView.innerText = ""

                    const file = event.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader()
                        reader.onload = function (e) {
                            imageView.src = e.target.result
                            imageView.style.display = 'block'
                            inputForm.dispatchEvent(new Event("submit"))
                        }
                        reader.readAsDataURL(file);
                    } else {
                        imageView.src = '';
                        imageView.style.display = 'none';
                    }
                })

                inputForm.addEventListener('submit', function (event) {
                    event.preventDefault()
                    resultView.innerText = "Đang xử lý"

                    fetch("/", { method: 'POST', body: new FormData(this) })
                        .then(response => response.json())
                        .then(result => {
                            result.sort((a, b) => a.x - b.x)
                            showIndicators(result)

                            resultView.innerText = "Kết quả:\n" + result.map(r => "- " + r.text).join("\n")
                        })
                        .catch(error => alert('Nhập file lỗi.'))
                })

                currentScript.remove()
            }
        </script>
    </div>

</body>

</html>
